version: 2.1
executors:
  pyinstaller:
    docker:
      - image: amazonlinux:2
jobs:
  build-binary:
    executor: pyinstaller
    steps:
      - checkout
      - run: ldd --version
      - run: yum install -y git
      - run: ldd --version
      - run: curl https://pyenv.run | bash
      - run:
             export PATH="$HOME/.pyenv/bin:$PATH"
             
             echo ' ' >> ~/.bash_profile
             
             echo '# Pyenv Configuration' >> ~/.bash_profile
             
             echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bash_profile
             
             echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bash_profile
             
             echo 'eval "$(pyenv init -)"' >> ~/.bash_profile

             source ~/.bash_profile
             
      - run: pyenv version
      - run: pyenv install 3.8
      - run: pyenv global 3.8
      - run: python --version
      - run: python -m pip install --no-cache-dir pipenv
      - run: pipenv run pip install pyinstaller
      - run: ldd --version
      - run: pipenv run pip install semgrep==1.52.0 --target ./semgrepinstall
      - run: >
          { echo '#!/usr/bin/env python3'; cat ./semgrepinstall/semgrep/main.py;
          echo 'sys.exit(main())';} > tempfile

          mv tempfile ./semgrepinstall/semgrep/main.py

          cp ./semgrepinstall/semgrep/main.py
          ./semgrepinstall/semgrep/__main__.py

          cat ./semgrepinstall/semgrep/main.py
      - run:  pipenv run pyinstaller semgrep.spec
      - store_artifacts:
          path: dist/semgrep
          destination: semgrep-linux
workflows:
  binary-builder:
    jobs:
      - build-binary
